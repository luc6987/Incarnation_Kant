# Digital Kant Baseline v2.0 - Cursor AI 规则
# 用于提高代码性能、可维护性和一致性

## 🎯 项目核心原则

1. **模块化设计**: 每个模块职责单一，接口清晰
2. **类型安全**: 使用类型注解，提高代码可读性和 IDE 支持
3. **配置驱动**: 将硬编码值提取到配置文件
4. **错误处理**: 优雅处理异常，提供有意义的错误信息
5. **性能优化**: 关注向量检索、LLM 调用的性能瓶颈
6. **文档完善**: 函数、类、模块都要有清晰的文档字符串

## 📝 代码风格规范

### Python 代码风格
- 遵循 PEP 8 规范
- 使用 `black` 格式化（行长度 100）
- 使用 `ruff` 进行 linting
- 类型注解：所有函数参数和返回值都要有类型注解
- 文档字符串：使用 Google 风格

```python
def example_function(param1: str, param2: int) -> dict[str, Any]:
    """函数简短描述。
    
    Args:
        param1: 参数1的描述
        param2: 参数2的描述
    
    Returns:
        返回值的描述
    
    Raises:
        ValueError: 当参数无效时抛出
    """
    pass
```

### 命名规范
- **模块名**: 小写，下划线分隔 (`database_builder.py`)
- **类名**: 大驼峰 (`DatabaseBuilder`)
- **函数/变量名**: 小写下划线 (`build_database`)
- **常量**: 全大写下划线 (`MAX_CHUNK_SIZE`)
- **私有方法**: 单下划线前缀 (`_internal_method`)

## 🏗️ 架构模式

### 1. 配置管理
- 所有配置通过 `pydantic-settings` 管理
- 环境变量使用 `.env` 文件
- 配置文件使用 YAML 格式，放在 `config/` 目录
- 配置类使用单例模式或依赖注入

### 2. 日志系统
- 使用 `loguru` 进行日志记录
- 日志级别：DEBUG, INFO, WARNING, ERROR, CRITICAL
- 日志文件存储在 `logs/` 目录
- 关键操作（数据库构建、检索、生成）都要记录日志

### 3. 错误处理
- 自定义异常类，继承自项目基础异常
- 使用上下文管理器处理资源（文件、数据库连接）
- 关键操作使用 try-except，记录详细错误信息

```python
class KantProjectError(Exception):
    """项目基础异常类"""
    pass

class DatabaseError(KantProjectError):
    """数据库相关错误"""
    pass
```

### 4. 异步处理
- I/O 密集型操作（网络请求、数据库查询）考虑使用异步
- 使用 `asyncio` 和 `aiohttp` 进行异步 HTTP 请求
- ChromaDB 操作如果支持异步，优先使用异步接口

## ⚡ 性能优化指南

### 1. 向量检索优化
- 使用批量检索而非循环单个检索
- 缓存常用的 embedding 结果
- 考虑使用 FAISS 作为 ChromaDB 的替代（如果性能要求更高）
- 限制检索结果数量（top_k），避免返回过多无关结果

### 2. LLM 调用优化
- 缓存相同 prompt 的生成结果
- 使用流式输出（streaming）提升用户体验
- 合理设置 `temperature` 和 `max_tokens`
- 批量处理多个请求（如果 API 支持）

### 3. 数据处理优化
- 使用生成器（generator）处理大文件，避免一次性加载到内存
- 文本切分使用高效的正则表达式或专门的分段库
- 使用多进程处理大量文件的清洗和切分

### 4. 数据库构建优化
- 增量更新：只处理新增或修改的文件
- 并行处理：使用 `multiprocessing` 或 `concurrent.futures` 并行处理多个文件
- 检查点机制：支持断点续传，避免重复处理

## 🔧 代码组织模式

### 模块导入顺序
1. 标准库
2. 第三方库
3. 本地模块

```python
# 标准库
import os
from typing import Optional, List

# 第三方库
import chromadb
from loguru import logger

# 本地模块
from src.utils.logger import setup_logger
from src.database.config import DatabaseConfig
```

### 类设计原则
- 单一职责原则：每个类只做一件事
- 依赖注入：通过构造函数注入依赖，便于测试
- 接口抽象：使用 ABC 定义接口，便于扩展

```python
from abc import ABC, abstractmethod

class Retriever(ABC):
    """检索器抽象基类"""
    
    @abstractmethod
    def retrieve(self, query: str, top_k: int = 5) -> List[dict]:
        """检索相关文档"""
        pass
```

### 函数设计
- 函数保持简短（< 50 行）
- 避免深层嵌套（最多 3 层）
- 使用早期返回（early return）减少嵌套
- 纯函数优先：输入相同，输出相同，无副作用

## 🧪 测试要求

### 测试覆盖率
- 核心业务逻辑测试覆盖率 > 80%
- 关键模块（HyDE、重述引擎）必须有单元测试
- 集成测试覆盖主要工作流

### 测试组织
- 单元测试：测试单个函数/类
- 集成测试：测试模块间协作
- 端到端测试：测试完整用户流程

### Mock 使用
- 外部 API（Gemini）调用必须 mock
- 数据库操作使用测试数据库或 mock
- 文件操作使用临时目录

## 📦 依赖管理

### 版本固定
- 生产依赖：使用 `>=` 指定最低版本，允许补丁更新
- 关键依赖：考虑使用精确版本（`==`）确保稳定性
- 定期更新依赖，检查安全漏洞

### 依赖分离
- 开发依赖放在 `requirements-dev.txt`
- 可选依赖（如 GPU 支持）单独列出

## 🔐 安全与隐私

### API 密钥管理
- **永远不要**将 API 密钥硬编码在代码中
- 使用环境变量或 `.env` 文件
- `.env` 文件必须添加到 `.gitignore`
- 提供 `.env.example` 作为模板

### 数据安全
- 敏感数据（用户查询日志）考虑加密存储
- 遵守数据隐私法规（GDPR 等）

## 📚 文档要求

### 代码文档
- 所有公共 API 必须有文档字符串
- 复杂算法需要注释说明
- README 保持更新，包含快速开始指南

### 类型注解
- 使用 `typing` 模块的类型注解
- 复杂类型使用 `TypedDict` 或 `dataclass`
- 返回类型明确，避免使用 `Any`（除非必要）

## 🚀 开发工作流

### Git 提交规范
- 提交信息使用中文或英文，清晰描述变更
- 格式：`<type>: <description>`
- 类型：feat, fix, docs, style, refactor, test, chore

### 代码审查检查清单
- [ ] 代码通过 linting 检查
- [ ] 类型注解完整
- [ ] 有适当的错误处理
- [ ] 有日志记录
- [ ] 有单元测试
- [ ] 文档字符串完整
- [ ] 性能考虑（特别是向量检索和 LLM 调用）

## 🎨 特定模块规范

### 数据库模块 (`src/database/`)
- 使用上下文管理器管理数据库连接
- 支持事务和回滚
- 提供数据迁移脚本

### HyDE 模块 (`src/hyde/`)
- 翻译 prompt 模板化，便于调整
- 支持多语言检测和路由
- 缓存翻译结果（相同输入）

### 重述模块 (`src/rearticulation/`)
- System prompt 模板化，支持 A/B 测试
- 输出格式统一（Markdown）
- 支持流式输出

### Streamlit 应用 (`app/`)
- UI 组件模块化，可复用
- 状态管理清晰（使用 session_state）
- 错误信息用户友好
- 加载状态提示（spinner）

## 🔍 代码审查重点

当 AI 助手生成代码时，请检查：
1. **性能**: 是否有不必要的循环？可以批量处理吗？
2. **错误处理**: 是否处理了所有可能的异常？
3. **类型安全**: 类型注解是否完整和准确？
4. **可测试性**: 代码是否易于单元测试？
5. **可维护性**: 代码是否清晰，易于理解？
6. **配置化**: 硬编码值是否应该提取到配置？
7. **日志**: 关键操作是否有日志记录？

## 📌 特殊注意事项

### 18 世纪德语文本处理
- 保留原始文本的完整性，不做现代化处理
- 引用元数据（如 `[AA III, 45]`）必须保留
- 文本编码使用 UTF-8，注意特殊字符

### 多语言支持
- 语言检测使用 `langdetect`，但要有回退机制
- 支持的语言列表配置化
- 错误信息支持多语言（可选）

### ChromaDB 使用
- 使用持久化存储，避免每次重建索引
- 定期备份数据库文件
- 考虑索引优化（如果数据量大）

## 🎯 代码生成时的提示

当用户要求生成代码时：
1. **先理解需求**: 确认模块、功能、输入输出
2. **检查现有代码**: 避免重复实现，复用现有工具
3. **遵循架构**: 按照项目结构组织代码
4. **添加类型注解**: 所有函数都要有类型注解
5. **添加文档字符串**: 使用 Google 风格
6. **考虑错误处理**: 添加适当的异常处理
7. **添加日志**: 关键操作记录日志
8. **考虑性能**: 特别是向量检索和 LLM 调用
9. **可测试性**: 代码结构便于单元测试

## 🔄 重构建议

当发现以下情况时，建议重构：
- 函数超过 50 行
- 类超过 300 行
- 重复代码超过 3 次
- 深层嵌套（> 3 层）
- 魔法数字/字符串（应提取为常量或配置）

---

**最后更新**: 2026-01-XX
**维护者**: Digital Kant Team
